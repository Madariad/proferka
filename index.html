<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Audio Visualizer</title>
    <style>
        canvas {
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <canvas id="audioCanvas" width="400" height="400"></canvas>

    <script>
        // Код для Microphone и визуализации
        function Microphone(_fft) {
            var FFT_SIZE = _fft || 1024;
            this.spectrum = new Uint8Array(FFT_SIZE/2);
            this.volume = 0;
            this.peak_volume = 0;
            var audioContext = new (window.AudioContext || window.webkitAudioContext)();
            var analyser = audioContext.createAnalyser();
            analyser.fftSize = FFT_SIZE;

            // Проверка поддержки браузером и запрос доступа к микрофону
            navigator.mediaDevices.getUserMedia({ audio: true }).then(processSound).catch(error);

            function processSound(stream) {
                var source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                var processor = audioContext.createScriptProcessor(FFT_SIZE, 1, 1);
                processor.onaudioprocess = function() {
                    analyser.getByteFrequencyData(this.spectrum);
                    this.volume = getRMS(this.spectrum);
                    if (this.volume > this.peak_volume) this.peak_volume = this.volume;
                }.bind(this);
                analyser.connect(processor);
                processor.connect(audioContext.destination);
            }

            function error(err) {
                console.error("The following error occurred: " + err.name);
            }

            function getRMS(spectrum) {
                var rms = 0;
                for (var i = 0; i < spectrum.length; i++) {
                    rms += spectrum[i] * spectrum[i];
                }
                rms /= spectrum.length;
                rms = Math.sqrt(rms);
                return rms;
            }

            this.getRMS = getRMS;
        }

        var Mic = new Microphone(2048);

        // Визуализация
        var canvas = document.getElementById('audioCanvas');
        var ctx = canvas.getContext('2d');
        var w = canvas.width;
        var h = canvas.height;

        function draw() {
            requestAnimationFrame(draw);
            var s = Mic.getRMS(Mic.spectrum);
            ctx.clearRect(0, 0, w, h); // Очистка холста
            ctx.fillStyle = 'rgb(' + s * 2 + ', 50, 50)';
            ctx.beginPath();
            ctx.arc(w / 2, h / 2, s * 2, 0, Math.PI * 2, false);
            ctx.fill();
        }

        draw();
    </script>
</body>
</html>
